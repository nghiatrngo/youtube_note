<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Note Clipper - Cloud Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar { transition: all 0.3s ease; }
        .sidebar-collapsed { width: 0; overflow: hidden; }
        .h-full { height: calc(100vh - 4rem); }
        
        /* Video player styling */
        #player-container {
            position: relative;
            width: 100%;
        }
        
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #player-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Ensure YouTube iframe fills container */
        #player iframe {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Sidebar collapsible styling */
        .sidebar {
            transition: all 0.3s ease;
            width: 20rem; /* 320px */
        }
        
        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }
        
        .sidebar.collapsed * {
            display: none;
        }
        
        /* Main content expands when sidebar is collapsed */
        .main-content {
            transition: all 0.3s ease;
        }
        
        /* Theme CSS Variables */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-sidebar: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
        }
        
        /* Light Theme (Default) */
        [data-theme="light"] {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-sidebar: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
        }
        
        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-sidebar: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
        }
        
        /* Blue Theme */
        [data-theme="blue"] {
            --bg-primary: #eff6ff;
            --bg-secondary: #ffffff;
            --bg-sidebar: #dbeafe;
            --text-primary: #1e40af;
            --text-secondary: #3b82f6;
            --border-color: #93c5fd;
            --accent-color: #2563eb;
            --accent-hover: #1d4ed8;
        }
        
        /* Green Theme */
        [data-theme="green"] {
            --bg-primary: #f0fdf4;
            --bg-secondary: #ffffff;
            --bg-sidebar: #dcfce7;
            --text-primary: #166534;
            --text-secondary: #16a34a;
            --border-color: #86efac;
            --accent-color: #16a34a;
            --accent-hover: #15803d;
        }
        
        /* Purple Theme */
        [data-theme="purple"] {
            --bg-primary: #faf5ff;
            --bg-secondary: #ffffff;
            --bg-sidebar: #f3e8ff;
            --text-primary: #7c3aed;
            --text-secondary: #a855f7;
            --border-color: #c4b5fd;
            --accent-color: #9333ea;
            --accent-hover: #7c3aed;
        }
        
        /* Apply theme variables to entire page */
        body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        
        header {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        #sidebar {
            background-color: var(--bg-sidebar) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Override Tailwind classes with theme variables */
        .bg-white, .bg-gray-100 {
            background-color: var(--bg-secondary) !important;
        }
        
        .bg-gray-50 {
            background-color: var(--bg-primary) !important;
        }
        
        .text-gray-800, .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        .text-gray-600, .text-gray-700 {
            color: var(--text-secondary) !important;
        }
        
        .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        
        .border-gray-200, .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        
        /* Theme-specific button colors */
        .bg-blue-600 {
            background-color: var(--accent-color) !important;
        }
        
        .hover\:bg-blue-700:hover {
            background-color: var(--accent-hover) !important;
        }
        
        /* Modal and form styling */
        #auth-modal .bg-white {
            background-color: var(--bg-secondary) !important;
        }
        
        #auth-modal .text-gray-700 {
            color: var(--text-primary) !important;
        }
        
        #auth-modal .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        
        /* Input fields */
        input, textarea {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Focus states */
        input:focus, textarea:focus {
            border-color: var(--accent-color) !important;
            ring-color: var(--accent-color) !important;
        }
        
        /* Toast notifications */
        #toast {
            background-color: var(--accent-color) !important;
        }
        
        /* Video controls toolbar */
        #video-controls-toolbar {
            background-color: var(--bg-secondary) !important;
        }
        
        /* Main content area */
        main {
            background-color: var(--bg-secondary) !important;
        }
        
        /* Note cards and containers */
        .bg-white.border {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* User profile section */
        .bg-gradient-to-r {
            background: linear-gradient(to right, var(--accent-color), var(--accent-hover)) !important;
        }
        
        /* Additional theme overrides for complete coverage */
        .bg-gray-100 {
            background-color: var(--bg-primary) !important;
        }
        
        .bg-gray-200 {
            background-color: var(--bg-secondary) !important;
        }
        
        .text-gray-400 {
            color: var(--text-secondary) !important;
        }
        
        .text-gray-300 {
            color: var(--text-secondary) !important;
        }
        
        /* Button hover states */
        .hover\:bg-gray-100:hover {
            background-color: var(--bg-primary) !important;
        }
        
        .hover\:bg-gray-200:hover {
            background-color: var(--bg-secondary) !important;
        }
        
        /* Shadow and border utilities */
        .shadow-sm, .shadow-lg {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Ensure video player container maintains black background */
        #player-container {
            background-color: #000000 !important;
        }
        
        /* Theme dropdown styling */
        #theme-dropdown {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        #theme-dropdown .theme-option:hover {
            background-color: var(--bg-primary) !important;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b px-4 py-3">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <!-- Sidebar Toggle Button -->
                <button id="sidebar-toggle" class="text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-100 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-lg font-bold text-gray-800">YouTube Note Clipper</h1>
                
                <!-- Load Video Section -->
                <div class="flex items-center space-x-2">
                    <button id="toolbar-load-video" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 transition">
                        Load Video
                    </button>
                </div>
            </div>

            <!-- Video Controls Toolbar -->
                            <div id="video-controls-toolbar" class="flex items-center space-x-2 hidden">
                    <button id="toolbar-play-pause" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition">
                        ▶ Play
                    </button>
                    <button id="toolbar-frame-back" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs transition">
                        -1 Frame
                    </button>
                    <button id="toolbar-frame-forward" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs transition">
                        +1 Frame
                    </button>
                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                    <button id="toolbar-set-start" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition">
                        Set Start
                    </button>
                    <button id="toolbar-set-end" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition">
                        Set End
                    </button>
                    <div class="flex items-center space-x-2 text-xs text-gray-600">
                        <span>Start: <span id="toolbar-start-time" class="font-mono">00:00</span></span>
                        <span>End: <span id="toolbar-end-time" class="font-mono">00:00</span></span>
                    </div>
                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                    <button id="toolbar-speed-50" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition">
                        50%
                    </button>
                    <button id="toolbar-speed-150" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition">
                        150%
                    </button>
                    <button id="toolbar-stop-looping" class="hidden bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition">
                        Stop Loop
                    </button>
                    </div>
            
            <div class="flex items-center space-x-3">
                <!-- Theme Selector -->
                <div class="relative">
                    <button id="theme-selector" class="bg-gray-600 text-white px-3 py-1.5 rounded text-sm hover:bg-gray-700 transition flex items-center space-x-2">
                        <span>🎨</span>
                        <span>Theme</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="theme-dropdown" class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                        <div class="py-2">
                            <button class="theme-option w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-theme="light">
                                ☀️ Light
                            </button>
                            <button class="theme-option w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-theme="dark">
                                🌙 Dark
                            </button>
                            <button class="theme-option w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-theme="blue">
                                🔵 Blue
                            </button>
                            <button class="theme-option w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-theme="green">
                                🟢 Green
                            </button>
                            <button class="theme-option w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-theme="purple">
                                🟣 Purple
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- User Info (hidden by default) -->
                <div id="user-info" class="hidden flex items-center space-x-3">
                    <span class="text-gray-600 text-sm">Welcome, <span id="username-display">Username</span></span>
                    <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Logout</button>
                    </div>
                
                <!-- Login Button (shown by default) -->
                <button id="login-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 transition">Login</button>
            </div>
        </div>
    </header>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Login / Register</h2>
                <button id="close-auth" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
            </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Login</button>
                <button type="button" id="show-register" class="w-full text-blue-600 hover:underline">Create Account</button>
            </form>
            
            <!-- Register Form -->
            <form id="register-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="register-username" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="register-email" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="register-password" required minlength="6" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Create Account</button>
                <button type="button" id="show-login" class="w-full text-blue-600 hover:underline">Already have account?</button>
            </form>
                    </div>
                </div>

    <!-- Main Container -->
    <div class="flex h-full">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar w-80 bg-white border-r border-gray-200 flex-shrink-0">
                <!-- User Profile Section -->
                <div class="p-4">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-xl font-bold">
                                <span id="user-avatar">U</span>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold" id="profile-username">Username</h2>
                                <p class="text-blue-100 text-sm" id="profile-email">email@example.com</p>
                            </div>
                        </div>
                        <div class="flex space-x-4 mt-3 text-sm">
                            <div>
                                <span class="font-bold" id="total-notes">0</span>
                                <span class="text-blue-100"> notes</span>
                            </div>
                            <div>
                                <span class="font-bold" id="total-videos">0</span>
                                <span class="text-blue-100"> videos</span>
                            </div>
                        </div>
                    </div>

                    <!-- All Notes Sidebar -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-semibold text-gray-800">All My Notes</h3>
                            <button id="refresh-all-notes" class="text-blue-600 hover:text-blue-800 text-xs">Refresh</button>
                        </div>
                        <div id="all-notes-sidebar" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-center py-6 text-sm">Loading notes...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col min-w-0">
                <!-- Main Content -->
                <main class="flex-1 bg-white p-4 lg:p-6 w-full">


                


                    <!-- Video and Notes Section -->
                    <div class="grid grid-cols-1 xl:grid-cols-4 gap-4 lg:gap-6">
                    <!-- Video Player -->
                        <div class="xl:col-span-3">
                            <!-- YouTube Player -->
                        <div id="player-container" class="bg-black rounded-lg overflow-hidden shadow-inner" style="aspect-ratio: 16/9;">
                                 <div id="player-placeholder" class="w-full h-full flex items-center justify-center text-gray-400">
                                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span class="ml-4">Video will appear here</span>
                                </div>
                            <div id="player" class="w-full h-full"></div>
                            </div>
                                </div>

                    <!-- Right Sidebar with Note Input and Current Notes -->
                    <div class="xl:col-span-1 space-y-4">
                        <!-- Note Input Area -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">Create a Clip</h3>
                                <textarea id="note-text" class="w-full p-3 border border-gray-300 rounded-lg h-24 focus:ring-2 focus:ring-blue-500" placeholder="Write your note for this clip..."></textarea>
                                <button id="add-note" class="mt-3 w-full bg-green-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-600 transition shadow-md">
                                    Add Note & Clip
                                </button>
                        </div>

                        <!-- Current Video Notes -->
                            <div class="bg-white border border-gray-200 rounded-lg p-4 h-fit">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800">Current Video Notes</h3>
                                <div id="current-video-notes" class="space-y-3 max-h-96 overflow-y-auto">
                                    <p class="text-gray-500 text-center py-8">No video loaded</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 opacity-0 translate-y-2"></div>

    <script>
        // Cloud-enabled version - can use either localStorage or cloud API
        console.log('🚀 YouTube Note Clipper - Cloud Version Loaded');
        
        // Configuration - Supabase-enabled API
        const API_BASE = 'https://youtube-note-clipper-api.onrender.com/api';
        const USE_CLOUD = true; // Set to false to use localStorage only

        // Global variables
        let player;
        let currentVideoId = '';
        let currentVideoTitle = '';
        let notes = [];
        let allNotes = [];
        let tempStartTime = 0;
        let tempEndTime = 0;
        let currentUser = null;
        let loopingNoteIndex = -1;
        let loopInterval;

        // DOM Elements - will be initialized after DOM loads
        let authModal, loginForm, registerForm, showRegisterBtn, showLoginBtn, logoutBtn;
        let userInfo, usernameDisplay, noteTaker;
        let addNoteBtn, noteText, stopLoopingBtn, loopingStatus, playerPlaceholder, toast;
        let sidebarToggle, sidebar, mainContent;
        let videoToolbar, videoControlsToolbar, toolbarLoadVideo, toolbarSetStart, toolbarSetEnd;
        let toolbarStartTime, toolbarEndTime, toolbarStopLooping, toolbarLoopingStatus;
        let toolbarPlayPause, toolbarFrameBack, toolbarFrameForward, toolbarSpeed50, toolbarSpeed150;
        let themeSelector, themeDropdown;

        // Check authentication on load
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('📱 DOM loaded, initializing application...');
                
                // Initialize DOM elements
                authModal = document.getElementById('auth-modal');
                loginForm = document.getElementById('login-form');
                registerForm = document.getElementById('register-form');
                showRegisterBtn = document.getElementById('show-register');
                showLoginBtn = document.getElementById('show-login');
                logoutBtn = document.getElementById('logout-btn');
                userInfo = document.getElementById('user-info');
                usernameDisplay = document.getElementById('username-display');


                noteTaker = document.getElementById('note-taker');
                addNoteBtn = document.getElementById('add-note');
                noteText = document.getElementById('note-text');
                stopLoopingBtn = document.getElementById('stop-looping');
                loopingStatus = document.getElementById('looping-status');
                playerPlaceholder = document.getElementById('player-placeholder');
                toast = document.getElementById('toast');
                sidebarToggle = document.getElementById('sidebar-toggle');
                sidebar = document.getElementById('sidebar');
                mainContent = document.querySelector('.flex-1');
                
                // Theme selector elements
                themeSelector = document.getElementById('theme-selector');
                themeDropdown = document.getElementById('theme-dropdown');
            
                // Toolbar elements
                videoControlsToolbar = document.getElementById('video-controls-toolbar');
                toolbarLoadVideo = document.getElementById('toolbar-load-video');
                toolbarSetStart = document.getElementById('toolbar-set-start');
                toolbarSetEnd = document.getElementById('toolbar-set-end');
                toolbarStartTime = document.getElementById('toolbar-start-time');
                toolbarEndTime = document.getElementById('toolbar-end-time');
                toolbarStopLooping = document.getElementById('toolbar-stop-looping');
                toolbarLoopingStatus = document.getElementById('toolbar-looping-status');
                toolbarPlayPause = document.getElementById('toolbar-play-pause');
                toolbarFrameBack = document.getElementById('toolbar-frame-back');
                toolbarFrameForward = document.getElementById('toolbar-frame-forward');
                toolbarSpeed50 = document.getElementById('toolbar-speed-50');
                toolbarSpeed150 = document.getElementById('toolbar-speed-150');
            
                // Add event listeners
                if (stopLoopingBtn) stopLoopingBtn.addEventListener('click', stopLoop);

                // Authentication event listeners
                if (showRegisterBtn) showRegisterBtn.addEventListener('click', () => {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                });

                if (showLoginBtn) showLoginBtn.addEventListener('click', () => {
                    registerForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                });

                if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

                // Form submissions
                if (loginForm) loginForm.addEventListener('submit', handleLogin);
                if (registerForm) registerForm.addEventListener('submit', handleRegister);
                
                // Sidebar toggle
                if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
                
                // Toolbar event listeners
                if (toolbarLoadVideo) toolbarLoadVideo.addEventListener('click', handleLoadVideo);
                if (toolbarSetStart) toolbarSetStart.addEventListener('click', () => setTime('start'));
                if (toolbarSetEnd) toolbarSetEnd.addEventListener('click', () => setTime('end'));
                if (toolbarStopLooping) toolbarStopLooping.addEventListener('click', stopLoop);
                if (toolbarPlayPause) toolbarPlayPause.addEventListener('click', togglePlayPause);
                if (toolbarFrameBack) toolbarFrameBack.addEventListener('click', () => seekFrame(-1));
                if (toolbarFrameForward) toolbarFrameForward.addEventListener('click', () => seekFrame(1));
                if (toolbarSpeed50) {
                    let clickCount = 0;
                    let clickTimer = null;
                    
                    toolbarSpeed50.addEventListener('click', () => {
                        clickCount++;
                        if (clickCount === 1) {
                            clickTimer = setTimeout(() => {
                                setPlaybackSpeed(0.5);
                                clickCount = 0;
                            }, 300);
                        } else if (clickCount === 2) {
                            clearTimeout(clickTimer);
                            setPlaybackSpeed(1.0);
                            clickCount = 0;
                        }
                    });
                }
                
                if (toolbarSpeed150) {
                    let clickCount = 0;
                    let clickTimer = null;
                    
                    toolbarSpeed150.addEventListener('click', () => {
                        clickCount++;
                        if (clickCount === 1) {
                            clickTimer = setTimeout(() => {
                                setPlaybackSpeed(1.5);
                                clickCount = 0;
                            }, 300);
                        } else if (clickCount === 2) {
                            clearTimeout(clickTimer);
                            setPlaybackSpeed(1.0);
                            clickCount = 0;
                        }
                    });
                }
                
                // Note taking event listeners
                if (addNoteBtn) {
                    console.log('✅ Add note button found, adding event listener');
                    addNoteBtn.addEventListener('click', handleAddNote);
                } else {
                    console.log('❌ Add note button not found');
                }
                
                // Theme selector event listeners
                if (themeSelector) {
                    themeSelector.addEventListener('click', toggleThemeDropdown);
                }
                
                // Theme option event listeners
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('theme-option')) {
                        const theme = e.target.getAttribute('data-theme');
                        setTheme(theme);
                        hideThemeDropdown();
                    }
                });
                
                // Close theme dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!themeSelector?.contains(e.target) && !themeDropdown?.contains(e.target)) {
                        hideThemeDropdown();
                    }
                });
                

                

            
            // Login button event listener
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) loginBtn.addEventListener('click', showAuthModal);
            
            // Close auth modal button
            const closeAuthBtn = document.getElementById('close-auth');
            if (closeAuthBtn) closeAuthBtn.addEventListener('click', hideAuthModal);
            
            // Initialize UI elements
            if (stopLoopingBtn) {
                stopLoopingBtn.classList.add('hidden');
            }
            if (loopingStatus) {
                loopingStatus.textContent = '';
            }
            
            console.log('✅ DOM elements initialized, checking authentication...');
            
            // Load saved theme
            loadSavedTheme();
            
            checkAuth();
            
            // Restore previous page state after authentication
            setTimeout(() => {
                restorePageState();
            }, 1000);
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                // Show error message to user
                if (toast) {
                    showToast('Error initializing application. Please refresh the page.', 'error');
                }
            }
        });

        // Authentication functions
        function checkAuth() {
            try {
                if (USE_CLOUD) {
                    // Check cloud token
                    const token = localStorage.getItem('cloudToken');
                    if (token) {
                        currentUser = JSON.parse(localStorage.getItem('cloudUser'));
                        hideAuthModal();
                        loadUserNotes();
                    } else {
                        showAuthModal();
                    }
                } else {
                    // Check localStorage
                    const user = localStorage.getItem('currentUser');
                    if (user) {
                        currentUser = JSON.parse(user);
                        hideAuthModal();
                        loadUserNotes();
                    } else {
                        showAuthModal();
                    }
                }
            } catch (error) {
                console.error('❌ Error during authentication check:', error);
                // Fallback to showing auth modal
                showAuthModal();
            }
        }

        function showAuthModal() {
            try {
                if (authModal) authModal.classList.remove('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                // Show login button when showing auth modal
                if (document.getElementById('login-btn')) {
                    document.getElementById('login-btn').classList.remove('hidden');
                }
            } catch (error) {
                console.error('❌ Error showing auth modal:', error);
            }
        }

        function hideAuthModal() {
            try {
                if (authModal) authModal.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                // Hide login button when user is logged in
                if (document.getElementById('login-btn')) {
                    document.getElementById('login-btn').classList.add('hidden');
                }
                if (usernameDisplay && currentUser) {
                    usernameDisplay.textContent = currentUser.username;
                }
                updateUserProfile();
            } catch (error) {
                console.error('❌ Error hiding auth modal:', error);
            }
        }
        
        // Sidebar toggle function
        function toggleSidebar() {
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                
                // Update toggle button icon
                if (sidebarToggle) {
                    const icon = sidebarToggle.querySelector('svg');
                    if (icon) {
                        if (sidebar.classList.contains('collapsed')) {
                            // Show expand icon
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>';
                        } else {
                            // Show collapse icon
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>';
                        }
                    }
                }
            }
        }
        

        

        
        // Theme functions
        function toggleThemeDropdown() {
            if (themeDropdown) {
                themeDropdown.classList.toggle('hidden');
            }
        }
        
        function hideThemeDropdown() {
            if (themeDropdown) {
                themeDropdown.classList.add('hidden');
            }
        }
        
        function setTheme(theme) {
            // Remove all theme classes
            document.documentElement.removeAttribute('data-theme');
            document.body.removeAttribute('data-theme');
            
            // Set new theme
            document.documentElement.setAttribute('data-theme', theme);
            document.body.setAttribute('data-theme', theme);
            
            // Save theme preference
            localStorage.setItem('selectedTheme', theme);
            
            // Show feedback
            const themeNames = {
                'light': 'Light',
                'dark': 'Dark',
                'blue': 'Blue',
                'green': 'Green',
                'purple': 'Purple'
            };
            showToast(`Theme changed to ${themeNames[theme]}`, 'success');
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
        }
        


        // Cloud API functions
        async function cloudLogin(email, password) {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('cloudToken', data.token);
                    localStorage.setItem('cloudUser', JSON.stringify(data.user));
                    currentUser = data.user;
                    return { success: true };
                } else {
                    return { success: false, message: data.message };
                }
            } catch (error) {
                console.error('Cloud login error:', error);
                return { success: false, message: 'Network error' };
            }
        }

        async function cloudRegister(username, email, password) {
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('cloudToken', data.token);
                    localStorage.setItem('cloudUser', JSON.stringify(data.user));
                    currentUser = data.user;
                    return { success: true };
                } else {
                    return { success: false, message: data.message };
                }
            } catch (error) {
                console.error('Cloud register error:', error);
                return { success: false, message: 'Network error' };
            }
        }

        // Authentication handlers
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (USE_CLOUD) {
                const result = await cloudLogin(email, password);
                if (result.success) {
                    hideAuthModal();
                    loadUserNotes();
                    showToast('Login successful!', 'success');
                } else {
                    showToast(result.message, 'error');
                }
            } else {
                // localStorage fallback
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.email === email && u.password === password);

                if (user) {
                    currentUser = { id: user.id, username: user.username, email: user.email };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    hideAuthModal();
                    loadUserNotes();
                    showToast('Login successful!', 'success');
                } else {
                    showToast('Invalid credentials', 'error');
                }
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            if (password.length < 6) {
                showToast('Password must be at least 6 characters long', 'error');
                return;
            }

            if (USE_CLOUD) {
                const result = await cloudRegister(username, email, password);
                if (result.success) {
                    hideAuthModal();
                    loadUserNotes();
                    showToast('Account created successfully!', 'success');
                } else {
                    showToast(result.message, 'error');
                }
            } else {
                // localStorage fallback
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                if (users.find(u => u.username === username || u.email === email)) {
                    showToast('Username or email already exists', 'error');
                    return;
                }

                const newUser = {
                    id: Date.now().toString(),
                    username,
                    email,
                    password
                };

                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                
                currentUser = { id: newUser.id, username: newUser.username, email: newUser.email };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                hideAuthModal();
                showToast('Account created successfully!', 'success');
            }
        }

        function handleLogout() {
            if (USE_CLOUD) {
                localStorage.removeItem('cloudToken');
                localStorage.removeItem('cloudUser');
            } else {
                localStorage.removeItem('currentUser');
            }
            
            currentUser = null;
            notes = [];
            allNotes = [];
            
            // Show login button and auth modal after logout
            if (document.getElementById('login-btn')) {
                document.getElementById('login-btn').classList.remove('hidden');
            }
            
            showAuthModal();
            showToast('Logged out successfully', 'info');
        }

        // Core utility functions
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Load video function
        async function handleLoadVideo() {
            // Get URL from prompt since we don't have a permanent input field
            const url = prompt('Enter YouTube URL:');
            if (!url || !url.trim()) {
                return;
            }
            
            const videoId = getYouTubeVideoId(url.trim());
            if (!videoId) {
                showToast('Please enter a valid YouTube URL', 'error');
                return;
            }
            
            // Stop any active loop when loading a new video
            if (typeof stopLoop === 'function') {
                stopLoop();
            }
            
            if (currentVideoId !== videoId) {
                currentVideoId = videoId;
                currentVideoTitle = await getVideoTitle(videoId);
                await loadVideoNotes(videoId);
                resetNoteTaker();
            }
            
            // Hide placeholder and show player
            if (playerPlaceholder) {
                playerPlaceholder.style.display = 'none';
            }
            
            // Load video in player
            if (typeof player !== 'undefined' && player && typeof player.loadVideoById === 'function') {
                player.loadVideoById(videoId);
            } else {
                // Create new player if it doesn't exist
                if (typeof YT !== 'undefined' && YT.Player) {
                    player = new YT.Player('player', {
                        videoId: videoId,
                        width: '100%',
                        height: '100%',
                        playerVars: { 
                            'playsinline': 1, 
                            'rel': 0,
                            'modestbranding': 1,
                            'showinfo': 0
                        },
                        events: { 'onPlayerReady': onPlayerReady }
                    });
                }
            }
            
            showToast(`Video loaded: ${currentVideoTitle}`, 'success');
            
            // Show video controls toolbar after video loads
            if (videoControlsToolbar) {
                videoControlsToolbar.classList.remove('hidden');
            }
            
            // No URL input to clear since we use prompt
            
            // Save current page state
            savePageState();
        }

        // Enhanced video title fetching
        async function getVideoTitle(videoId) {
            try {
                const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.title || `Video ${videoId}`;
                }
            } catch (error) {
                console.log('Could not fetch video title, using fallback');
            }
            
            return `Video ${videoId}`;
        }

        // Load video notes
        async function loadVideoNotes(videoId) {
            console.log('🔍 loadVideoNotes called with videoId:', videoId);
            
            // Check if user is authenticated via cloud or localStorage
            let user = currentUser;
            if (!user && USE_CLOUD) {
                const cloudUser = localStorage.getItem('cloudUser');
                if (cloudUser) {
                    user = JSON.parse(cloudUser);
                    currentUser = user; // Set currentUser for future use
                    console.log('✅ User authenticated via cloud:', user.username);
                }
            }
            if (!user) {
                const localUser = localStorage.getItem('currentUser');
                if (localUser) {
                    user = JSON.parse(localUser);
                    currentUser = user; // Set currentUser for future use
                    console.log('✅ User authenticated via localStorage:', user.username);
                }
            }
            
            if (!user) {
                console.log('❌ No user authenticated, cannot load video notes');
                return;
            }
            
            try {
                if (USE_CLOUD) {
                    const token = localStorage.getItem('cloudToken');
                    if (!token) {
                        console.log('No cloud token found');
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/notes/video/${videoId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        notes = data.notes || [];
                        console.log('✅ Cloud notes loaded:', notes.length, 'notes');
                        renderCurrentVideoNotes();
                    } else {
                        console.log('❌ Failed to fetch cloud notes:', response.status);
                        notes = [];
                        renderCurrentVideoNotes();
                    }
                } else {
                    // localStorage fallback
                    const userNotes = JSON.parse(localStorage.getItem(`notes_${user.id}`) || '[]');
                    notes = userNotes.filter(note => note.videoId === videoId);
                    console.log('✅ localStorage notes loaded:', notes.length, 'notes for video', videoId);
                    renderCurrentVideoNotes();
                }
            } catch (error) {
                console.error('Failed to load video notes:', error);
                notes = [];
                renderCurrentVideoNotes();
            }
        }

        // Load user notes
        async function loadUserNotes() {
            // Check if user is authenticated via cloud or localStorage
            let user = currentUser;
            if (!user && USE_CLOUD) {
                const cloudUser = localStorage.getItem('cloudUser');
                if (cloudUser) {
                    user = JSON.parse(cloudUser);
                    currentUser = user; // Set currentUser for future use
                }
            }
            if (!user) {
                const localUser = localStorage.getItem('currentUser');
                if (localUser) {
                    user = JSON.parse(localUser);
                    currentUser = user; // Set currentUser for future use
                }
            }
            
            if (!user) {
                console.log('No user authenticated, cannot load user notes');
                return;
            }
            
            try {
                if (USE_CLOUD) {
                    const token = localStorage.getItem('cloudToken');
                    if (!token) {
                        console.log('No cloud token found');
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/notes`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        allNotes = data.notes || [];
                        notes = allNotes.filter(note => note.videoId === currentVideoId);
                        renderCurrentVideoNotes();
                        renderAllNotesSidebar();
                        updateUserProfile();
                    } else {
                        console.log('Failed to fetch cloud notes:', response.status);
                        allNotes = [];
                        notes = [];
                        renderCurrentVideoNotes();
                        renderAllNotesSidebar();
                        updateUserProfile();
                    }
                } else {
                    // localStorage fallback
                    const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.id}`) || '[]');
                    allNotes = userNotes;
                    notes = allNotes.filter(note => note.videoId === currentVideoId);
                    renderCurrentVideoNotes();
                    renderAllNotesSidebar();
                    updateUserProfile();
                }
            } catch (error) {
                console.error('Failed to load user notes:', error);
                allNotes = [];
                notes = [];
                renderCurrentVideoNotes();
                renderAllNotesSidebar();
                updateUserProfile();
            }
        }

        // Render current video notes
        function renderCurrentVideoNotes() {
            console.log('🔍 renderCurrentVideoNotes called');
            console.log('currentVideoId:', currentVideoId);
            console.log('notes:', notes);
            console.log('currentUser:', currentUser);
            
            const container = document.getElementById('current-video-notes');
            if (!container) {
                console.log('❌ current-video-notes container not found');
                return;
            }
            
            if (!currentVideoId) {
                console.log('❌ No currentVideoId');
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No video loaded</p>';
                return;
            }
            
            if (notes.length === 0) {
                console.log('❌ No notes found for video:', currentVideoId);
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No notes for this video yet</p>';
                return;
            }
            
            let notesHTML = '';
            notes.forEach((note, index) => {
                notesHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border" data-note-id="${note.id}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-mono text-sm text-blue-600 note-time-display" data-note-id="${note.id}">${formatTime(note.startTime)} → ${formatTime(note.endTime)}</span>
                            <button onclick="deleteNote('${note.id}')" class="text-red-500 hover:text-red-700 text-sm">×</button>
                        </div>
                        <div class="note-content">
                            <p class="text-gray-700 text-sm note-text" data-note-id="${note.id}">${escapeHTML(note.text)}</p>
                            <div class="note-edit hidden" data-note-id="${note.id}">
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Start Time (seconds)</label>
                                        <input type="number" name="startTime" step="0.1" min="0" value="${note.startTime}" class="w-full p-2 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">End Time (seconds)</label>
                                        <input type="number" name="endTime" step="0.1" min="0" value="${note.endTime}" class="w-full p-2 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Note Text</label>
                                        <textarea class="w-full p-2 border border-gray-300 rounded text-sm" rows="2">${escapeHTML(note.text)}</textarea>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="saveNoteEdit('${note.id}')" class="text-xs bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600 transition">Save</button>
                                        <button onclick="cancelNoteEdit('${note.id}')" class="text-xs bg-gray-500 text-white py-1 px-2 rounded hover:bg-gray-600 transition">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="seekToTime(${note.startTime})" class="text-xs bg-blue-100 text-blue-700 py-1 px-2 rounded hover:bg-blue-200 transition">
                                Go to Start
                            </button>
                            <button onclick="playClip(${note.startTime}, ${note.endTime})" class="text-xs bg-green-100 text-green-700 py-1 px-2 rounded hover:bg-green-200 transition">
                                Play Clip
                            </button>
                            <button onclick="editNote('${note.id}')" class="text-xs bg-yellow-100 text-yellow-700 py-1 px-2 rounded hover:bg-yellow-200 transition">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = notesHTML;
        }

        // Add note function
        async function handleAddNote() {
            console.log('🔍 handleAddNote called');
            
            if (!currentUser) {
                showToast('Please login first', 'error');
                return;
            }

            if (!currentVideoId) {
                showToast('Please load a video first', 'error');
                return;
            }

            const text = noteText.value.trim();
            if (!text) {
                showToast('Please enter note text', 'error');
                return;
            }

            if (tempStartTime === 0 || tempEndTime === 0) {
                showToast('Please set both start and end times first', 'error');
                return;
            }

            if (tempStartTime >= tempEndTime) {
                showToast('Start time must be before end time', 'error');
                return;
            }

            // Use current video info
            const note = {
                videoId: currentVideoId,
                videoTitle: currentVideoTitle,
                startTime: tempStartTime,
                endTime: tempEndTime,
                text: text.trim()
            };

            try {
                if (USE_CLOUD) {
                    const token = localStorage.getItem('cloudToken');
                    const response = await fetch(`${API_BASE}/notes`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(note)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        notes.push(data.note);
                        allNotes.push(data.note);

            // Clear form
            noteText.value = '';
            tempStartTime = 0;
            tempEndTime = 0;
                        if (toolbarStartTime) toolbarStartTime.textContent = '00:00';
                        if (toolbarEndTime) toolbarEndTime.textContent = '00:00';

            // Update displays
            renderCurrentVideoNotes();
            renderAllNotesSidebar();
            updateUserProfile();

            showToast('Note added successfully!', 'success');
                        
                        // Save current page state
                        savePageState();
                    } else {
                        showToast('Failed to save note', 'error');
        }
                } else {
                    // localStorage fallback
                    note.id = Date.now().toString();
                    note.userId = currentUser.id;
                    note.createdAt = new Date().toISOString();

                    notes.push(note);
                    allNotes.push(note);
            
                    // Save to localStorage
                const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.id}`) || '[]');
                    userNotes.push(note);
                    localStorage.setItem(`notes_${currentUser.id}`, JSON.stringify(userNotes));
                    
                    // Clear form
                    noteText.value = '';
                    tempStartTime = 0;
                    tempEndTime = 0;
                    if (toolbarStartTime) toolbarStartTime.textContent = '00:00';
                    if (toolbarEndTime) toolbarEndTime.textContent = '00:00';
                    
                    // Update displays
                    renderCurrentVideoNotes();
                renderAllNotesSidebar();
                    updateUserProfile();
                    
                    showToast('Note added successfully!', 'success');
                    
                    // Save current page state
                    savePageState();
                }
            } catch (error) {
                console.error('Error adding note:', error);
                showToast('Failed to save note', 'error');
            }
        }
        
        // Update user profile
        function updateUserProfile() {
            if (!currentUser) return;
            
            // Update profile display
            const profileUsername = document.getElementById('profile-username');
            const profileEmail = document.getElementById('profile-email');
            const userAvatar = document.getElementById('user-avatar');
            
            if (profileUsername) profileUsername.textContent = currentUser.username;
            if (profileEmail) profileEmail.textContent = currentUser.email;
            if (userAvatar) userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            
            // Update stats
            const totalNotes = allNotes.length;
            const uniqueVideos = [...new Set(allNotes.map(note => note.videoId))].length;
            
            const totalNotesElement = document.getElementById('total-notes');
            const totalVideosElement = document.getElementById('total-videos');
            
            if (totalNotesElement) totalNotesElement.textContent = totalNotes;
            if (totalVideosElement) totalVideosElement.textContent = uniqueVideos;
            
            console.log('✅ User profile updated:', {
                username: currentUser.username,
                email: currentUser.email,
                totalNotes,
                uniqueVideos
            });
        }

        // Render all notes sidebar
        function renderAllNotesSidebar() {
            const container = document.getElementById('all-notes-sidebar');
            if (!container) return;
            
            if (allNotes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-6 text-sm">No notes yet</p>';
                return;
            }
            
            // Group notes by video
            const videoGroups = {};
            allNotes.forEach(note => {
                if (!videoGroups[note.videoId]) {
                    videoGroups[note.videoId] = [];
                }
                videoGroups[note.videoId].push(note);
            });
            
            let sidebarHTML = '';
            Object.entries(videoGroups).forEach(([videoId, videoNotes]) => {
                const videoTitle = videoNotes[0].videoTitle;
                const noteCount = videoNotes.length;
                
                sidebarHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border">
                        <h4 class="font-semibold text-sm text-gray-800 mb-2">${escapeHTML(videoTitle)}</h4>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-600">${noteCount} note${noteCount > 1 ? 's' : ''}</span>
                            <button onclick="loadVideoById('${videoId}')" class="bg-blue-500 text-white text-xs py-1 px-2 rounded hover:bg-blue-600 transition">
                                View Note
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = sidebarHTML;
        }

        // Load video by ID
        async function loadVideoById(videoId) {
            console.log('🔍 loadVideoById called with videoId:', videoId);
            
            // Stop any active loop when loading a new video
            if (typeof stopLoop === 'function') {
                stopLoop();
            }
            
            currentVideoId = videoId;
            
            // Get video title from existing notes
            const videoNotes = allNotes.filter(note => note.videoId === videoId);
            if (videoNotes.length > 0) {
                currentVideoTitle = videoNotes[0].videoTitle;
                console.log('Using existing video title:', currentVideoTitle);
            } else {
                // Fallback to fetching title
                currentVideoTitle = await getVideoTitle(videoId);
                console.log('Fetched video title:', currentVideoTitle);
            }
            
            // Load notes for this video
            await loadVideoNotes(videoId);
            
            // Reset note input only (don't hide video controls)
            if (noteText) noteText.value = '';
            if (toolbarStartTime) toolbarStartTime.textContent = '00:00';
            if (toolbarEndTime) toolbarEndTime.textContent = '00:00';
            tempStartTime = 0;
            tempEndTime = 0;
            
            // Hide placeholder and show player
            if (playerPlaceholder) {
                playerPlaceholder.style.display = 'none';
            }
            
            // Load video in player
            if (typeof player !== 'undefined' && player && typeof player.loadVideoById === 'function') {
                player.loadVideoById(videoId);
                console.log('✅ Video loaded in existing player');
            } else {
                // Create new player if it doesn't exist
                if (typeof YT !== 'undefined' && YT.Player) {
                    player = new YT.Player('player', {
                        videoId: videoId,
                        width: '100%',
                        height: '100%',
                        playerVars: { 
                            'playsinline': 1, 
                            'rel': 0,
                            'modestbranding': 1,
                            'showinfo': 0
                        },
                        events: { 'onPlayerReady': onPlayerReady }
                    });
                    console.log('✅ New player created');
                }
            }
            
            // Show video controls toolbar
            if (videoControlsToolbar) {
                videoControlsToolbar.classList.remove('hidden');
            }
            
            // Save current page state
            savePageState();
            
            showToast(`Video loaded: ${currentVideoTitle}`, 'success');
        }

        // Note editing functions
        function editNote(noteId) {
            const noteText = document.querySelector(`.note-text[data-note-id="${noteId}"]`);
            const noteEdit = document.querySelector(`.note-edit[data-note-id="${noteId}"]`);
            
            if (noteText && noteEdit) {
                noteText.classList.add('hidden');
                noteEdit.classList.remove('hidden');
                
                // Focus on the textarea
                const textarea = noteEdit.querySelector('textarea');
                if (textarea) {
                    textarea.focus();
                    textarea.select();
                }
            }
        }
        
        function cancelNoteEdit(noteId) {
            const noteText = document.querySelector(`.note-text[data-note-id="${noteId}"]`);
            const noteEdit = document.querySelector(`.note-edit[data-note-id="${noteId}"]`);
            
            if (noteText && noteEdit) {
                noteText.classList.remove('hidden');
                noteEdit.classList.add('hidden');
                
                // Reset the form inputs to original values
                const note = notes.find(n => n.id === noteId);
                if (note) {
                    const startTimeInput = noteEdit.querySelector('input[name="startTime"]');
                    const endTimeInput = noteEdit.querySelector('input[name="endTime"]');
                    const textarea = noteEdit.querySelector('textarea');
                    
                    if (startTimeInput) startTimeInput.value = note.startTime;
                    if (endTimeInput) endTimeInput.value = note.endTime;
                    if (textarea) textarea.value = note.text;
                }
            }
        }
        
        async function saveNoteEdit(noteId) {
            const noteEdit = document.querySelector(`.note-edit[data-note-id="${noteId}"]`);
            const textarea = noteEdit?.querySelector('textarea');
            const startTimeInput = noteEdit?.querySelector('input[name="startTime"]');
            const endTimeInput = noteEdit?.querySelector('input[name="endTime"]');
            
            if (!textarea) return;
            
            const newText = textarea.value.trim();
            if (!newText) {
                showToast('Note text cannot be empty', 'error');
                return;
            }
            
            // Parse time inputs
            let newStartTime = 0;
            let newEndTime = 0;
            
            if (startTimeInput && endTimeInput) {
                newStartTime = parseFloat(startTimeInput.value) || 0;
                newEndTime = parseFloat(endTimeInput.value) || 0;
                
                if (newStartTime >= newEndTime) {
                    showToast('End time must be greater than start time', 'error');
                    return;
                }
            }
            
            try {
                if (USE_CLOUD) {
                    const token = localStorage.getItem('cloudToken');
                    const response = await fetch(`${API_BASE}/notes/${noteId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            text: newText,
                            startTime: newStartTime,
                            endTime: newEndTime
                        })
                    });
                    
                    if (response.ok) {
                        // Update local note
                        const note = notes.find(n => n.id === noteId);
                        if (note) {
                            note.text = newText;
                            note.startTime = newStartTime;
                            note.endTime = newEndTime;
                        }
                        
                        const allNote = allNotes.find(n => n.id === noteId);
                        if (allNote) {
                            allNote.text = newText;
                            allNote.startTime = newStartTime;
                            allNote.endTime = newEndTime;
                        }
                        
                        // Update displays
                        renderCurrentVideoNotes();
                        renderAllNotesSidebar();
                        showToast('Note updated successfully!', 'success');
                        
                        // Refresh the displays to show all updates
                        setTimeout(() => {
                            // Refresh current video notes and sidebar without page reload
                            renderCurrentVideoNotes();
                            renderAllNotesSidebar();
                            showToast('Note updated and displays refreshed!', 'success');
                        }, 500);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('Server error:', errorData);
                        showToast(`Failed to update note: ${errorData.message || 'Server error'}`, 'error');
                    }
                } else {
                    // localStorage fallback
                    const note = notes.find(n => n.id === noteId);
                    if (note) {
                        note.text = newText;
                        note.startTime = newStartTime;
                        note.endTime = newEndTime;
                    }
                    
                    const allNote = allNotes.find(n => n.id === noteId);
                    if (allNote) {
                        allNote.text = newText;
                        allNote.startTime = newStartTime;
                        allNote.endTime = newEndTime;
                    }
                    
                    // Update localStorage
                    const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.id}`) || '[]');
                    const noteIndex = userNotes.findIndex(n => n.id === noteId);
                    if (noteIndex !== -1) {
                        userNotes[noteIndex].text = newText;
                        userNotes[noteIndex].startTime = newStartTime;
                        userNotes[noteIndex].endTime = newEndTime;
                        localStorage.setItem(`notes_${currentUser.id}`, JSON.stringify(userNotes));
                    }
                    
                    // Update displays
                    renderCurrentVideoNotes();
                    renderAllNotesSidebar();
                    showToast('Note updated successfully!', 'success');
                    
                    // Refresh the displays to show all updates
                    setTimeout(() => {
                        // Refresh current video notes and sidebar without page reload
                        renderCurrentVideoNotes();
                        renderAllNotesSidebar();
                        showToast('Note updated and displays refreshed!', 'success');
                    }, 500);
                }
            } catch (error) {
                console.error('Error updating note:', error);
                showToast('Failed to update note. Please try again.', 'error');
            }
        }
        
        // Delete note function
        async function deleteNote(noteId) {
            if (!currentUser) {
                showToast("Please log in to delete notes.", 'error');
                return;
            }

            try {
                if (USE_CLOUD) {
                    const token = localStorage.getItem('cloudToken');
                    const response = await fetch(`${API_BASE}/notes/${noteId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        notes = notes.filter(note => note.id !== noteId);
                        allNotes = allNotes.filter(note => note.id !== noteId);
                        
                        // Update displays
                        renderCurrentVideoNotes();
                        renderAllNotesSidebar();
                        updateUserProfile();
                        
                        showToast('Note deleted successfully!', 'success');
                    } else {
                        showToast('Failed to delete note', 'error');
                    }
                } else {
                    // localStorage fallback
                notes = notes.filter(note => note.id !== noteId);
                allNotes = allNotes.filter(note => note.id !== noteId);
                
                // Update localStorage
                const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.id}`) || '[]');
                const updatedNotes = userNotes.filter(note => note.id !== noteId);
                localStorage.setItem(`notes_${currentUser.id}`, JSON.stringify(updatedNotes));
                
                // Update displays
                renderCurrentVideoNotes();
                renderAllNotesSidebar();
                updateUserProfile();
                
                showToast('Note deleted successfully!', 'success');
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                showToast('Failed to delete note. Please try again.', 'error');
            }
        }

        // Helper functions for video controls
        function seekToTime(time) {
            if (player && typeof player.seekTo === 'function') {
                player.seekTo(time);
                showToast(`Seeking to ${formatTime(time)}`, 'info');
            }
        }
        
        function playClip(startTime, endTime) {
            if (player && typeof player.seekTo === 'function') {
                player.seekTo(startTime);
                player.playVideo();
                
                // Set up loop for this clip
                stopLoop();
                startLoop(startTime, endTime, -1);
                showToast(`Playing clip from ${formatTime(startTime)} to ${formatTime(endTime)}`, 'info');
            }
        }

        function startLoop(startTime, endTime, index) {
            if (!player || typeof player.seekTo !== 'function') return;
            stopLoop();
            loopingNoteIndex = index;
            player.seekTo(startTime);
            player.playVideo();

            // Show stop looping button (old)
            if (stopLoopingBtn) {
                stopLoopingBtn.classList.remove('hidden');
            }
            
            // Update looping status (old)
            if (loopingStatus) {
                loopingStatus.textContent = `(${formatTime(startTime)} → ${formatTime(endTime)})`;
            }
            
            // Show toolbar stop looping button
            if (toolbarStopLooping) {
                toolbarStopLooping.classList.remove('hidden');
            }
            
            // Update toolbar looping status
            if (toolbarLoopingStatus) {
                toolbarLoopingStatus.textContent = `(${formatTime(startTime)} → ${formatTime(endTime)})`;
            }

            loopInterval = setInterval(() => {
                if (player && typeof player.getCurrentTime === 'function') {
                    const currentTime = player.getCurrentTime();
                    if (currentTime >= endTime || currentTime < startTime) {
                        player.seekTo(startTime);
                    }
                }
            }, 250);
        }

        function stopLoop() {
            if (loopInterval) {
                clearInterval(loopInterval);
                loopInterval = null;
            }
            loopingNoteIndex = -1;
            
            // Hide stop looping button (old)
            if (stopLoopingBtn) {
                stopLoopingBtn.classList.add('hidden');
            }
            
            // Clear looping status (old)
            if (loopingStatus) {
                loopingStatus.textContent = '';
            }
            
            // Hide toolbar stop looping button
            if (toolbarStopLooping) {
                toolbarStopLooping.classList.add('hidden');
            }
            
            // Clear toolbar looping status
            if (toolbarLoopingStatus) {
                toolbarLoopingStatus.textContent = '';
            }
        }

        // Set time functions
        function setTime(type) {
            console.log('🔍 setTime called with type:', type);
            if (typeof player !== 'undefined' && player && typeof player.getCurrentTime === 'function') {
                const currentTime = Math.floor(player.getCurrentTime());
                console.log('Current player time:', currentTime);
                
                if (type === 'start') {
                    tempStartTime = currentTime;
                    console.log('Set start time to:', tempStartTime);
                    if (toolbarStartTime) {
                        toolbarStartTime.textContent = formatTime(currentTime);
                        console.log('Updated toolbar start time display');
                    }
                } else {
                    tempEndTime = currentTime;
                    console.log('Set end time to:', tempEndTime);
                    if (toolbarEndTime) {
                        toolbarEndTime.textContent = formatTime(currentTime);
                        console.log('Updated toolbar end time display');
                }
                }
                
                // Save state after setting time
                savePageState();
            } else {
                console.log('❌ Player not ready');
                showToast('Player not ready. Please wait for video to load.', 'warning');
            }
        }

        // Video Playback Control Functions
        function togglePlayPause() {
            if (!player || typeof player.getPlayerState !== 'function') {
                showToast('Player not ready', 'warning');
                return;
            }
            
            const playerState = player.getPlayerState();
            if (playerState === 1) { // Playing
                player.pauseVideo();
                if (toolbarPlayPause) {
                    toolbarPlayPause.innerHTML = '▶️ Play';
                    toolbarPlayPause.className = 'bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition';
                }
            } else { // Paused, ended, or buffering
                player.playVideo();
                if (toolbarPlayPause) {
                    toolbarPlayPause.innerHTML = '⏸️ Pause';
                    toolbarPlayPause.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition';
                }
            }
        }
        
        function seekFrame(direction) {
            if (!player || typeof player.getCurrentTime !== 'function') {
                showToast('Player not ready', 'warning');
                return;
            }
            
            // Pause video first for precise frame navigation
            if (player.getPlayerState() === 1) { // If playing
                player.pauseVideo();
                // Update play/pause button state
                updatePlayPauseButton();
            }
            
            // YouTube videos are typically 30fps, so 1 frame = 1/30 second
            const frameTime = 1/30;
            const currentTime = player.getCurrentTime();
            const newTime = currentTime + (direction * frameTime);
            
            // Ensure we don't go below 0
            if (newTime < 0) {
                player.seekTo(0);
            } else {
                player.seekTo(newTime);
            }
            
            // Show feedback
            const frameText = direction > 0 ? '+1 frame' : '-1 frame';
            showToast(`Paused and seeked ${frameText}`, 'info');
        }
        
        // Set playback speed function
        function setPlaybackSpeed(speed) {
            if (!player || typeof player.setPlaybackRate !== 'function') {
                showToast('Player not ready', 'error');
                return;
            }
            
            try {
                player.setPlaybackRate(speed);
                
                // Update button states to show which speed is active
                if (toolbarSpeed50) {
                    if (speed === 0.5) {
                        toolbarSpeed50.className = 'bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition';
                    } else {
                        toolbarSpeed50.className = 'bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition';
                    }
                }
                
                if (toolbarSpeed150) {
                    if (speed === 1.5) {
                        toolbarSpeed150.className = 'bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition';
                    } else {
                        toolbarSpeed150.className = 'bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition';
                    }
                }
                
                // Show feedback
                const speedText = Math.round(speed * 100) + '%';
                showToast(`Playback speed set to ${speedText}`, 'info');
                
            } catch (error) {
                console.error('Error setting playback speed:', error);
                showToast('Failed to set playback speed', 'error');
            }
        }
        
        // State persistence functions
        function savePageState() {
            const state = {
                currentVideoId: currentVideoId,
                currentVideoTitle: currentVideoTitle,
                tempStartTime: tempStartTime,
                tempEndTime: tempEndTime,
                notes: notes,
                allNotes: allNotes,
                currentUser: currentUser,
                videoControlsVisible: videoControlsToolbar ? !videoControlsToolbar.classList.contains('hidden') : false,
                currentTheme: localStorage.getItem('selectedTheme') || 'light'
            };
            localStorage.setItem('youtubeNoteClipper_state', JSON.stringify(state));
        }
        
        function restorePageState() {
            try {
                const savedState = localStorage.getItem('youtubeNoteClipper_state');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    
                    // Restore basic state
                    currentVideoId = state.currentVideoId || '';
                    currentVideoTitle = state.currentVideoTitle || '';
                    tempStartTime = state.tempStartTime || 0;
                    tempEndTime = state.tempEndTime || 0;
                    notes = state.notes || [];
                    allNotes = state.allNotes || [];
                    
                    // Restore user if still valid
                    if (state.currentUser) {
                        if (USE_CLOUD) {
                            const cloudToken = localStorage.getItem('cloudToken');
                            if (cloudToken) {
                                currentUser = state.currentUser;
                            }
                        } else {
                            currentUser = state.currentUser;
                        }
                    }
                    
                    // Restore UI state
                    if (state.currentVideoId && state.currentVideoTitle) {
                        // Restore video player
                        if (typeof YT !== 'undefined' && YT.Player) {
                            player = new YT.Player('player', {
                                videoId: state.currentVideoId,
                                width: '100%',
                                height: '100%',
                                playerVars: { 
                                    'playsinline': 1, 
                                    'rel': 0,
                                    'modestbranding': 1,
                                    'showinfo': 0
                                },
                                events: { 'onPlayerReady': onPlayerReady }
                            });
                        }
                        
                        // Hide placeholder and show controls
                        if (playerPlaceholder) {
                            playerPlaceholder.style.display = 'none';
                        }
                        
                        // Show video controls toolbar
                        if (videoControlsToolbar) {
                            videoControlsToolbar.classList.remove('hidden');
                        }
                        
                        // Update time displays
                        if (toolbarStartTime) toolbarStartTime.textContent = formatTime(tempStartTime);
                        if (toolbarEndTime) toolbarEndTime.textContent = formatTime(tempEndTime);
                        
                        // Render notes
                        renderCurrentVideoNotes();
                        renderAllNotesSidebar();
                        
                        showToast('Previous session restored!', 'success');
                    }
                    
                    // Restore theme if available
                    if (state.currentTheme) {
                        setTheme(state.currentTheme);
                    }
                }
            } catch (error) {
                console.error('Error restoring page state:', error);
            }
        }

        // Helper and UI Functions
        function resetNoteTaker() {
            noteText.value = '';
            tempStartTime = 0;
            tempEndTime = 0;

            if (toolbarStartTime) toolbarStartTime.textContent = '00:00';
            if (toolbarEndTime) toolbarEndTime.textContent = '00:00';
            
            // Hide stop looping button when resetting
            if (stopLoopingBtn) {
                stopLoopingBtn.classList.add('hidden');
            }
            
            // Clear looping status when resetting
            if (loopingStatus) {
                loopingStatus.textContent = '';
            }
            
            // Hide toolbar stop looping button when resetting
            if (toolbarStopLooping) {
                toolbarStopLooping.classList.add('hidden');
            }
            
            // Clear toolbar looping status when resetting
            if (toolbarLoopingStatus) {
                toolbarLoopingStatus.textContent = '';
            }
            
            // Hide header toolbar when resetting
            if (videoControlsToolbar) {
                videoControlsToolbar.classList.add('hidden');
            }
            
            // Reset speed buttons to default state
            if (toolbarSpeed50) {
                toolbarSpeed50.className = 'bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition';
            }
            if (toolbarSpeed150) {
                toolbarSpeed150.className = 'bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition';
            }
            
            // Reset playback speed to 100%
            if (player && typeof player.setPlaybackRate === 'function') {
                try {
                    player.setPlaybackRate(1.0);
                } catch (error) {
                    console.log('Could not reset playback speed');
                }
            }
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function showToast(message, type = 'info') {
            if (!toast) return;
            
            // Map type to colors and icons
            const toastConfig = {
                'success': { bg: 'bg-green-600', icon: '✅' },
                'error': { bg: 'bg-red-600', icon: '❌' },
                'warning': { bg: 'bg-yellow-600', icon: '⚠️' },
                'info': { bg: 'bg-blue-600', icon: 'ℹ️' }
            };
            
            const config = toastConfig[type] || toastConfig.info;
            
            toast.innerHTML = `${config.icon} ${message}`;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 ${config.bg}`;
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.appendChild(document.createTextNode(str));
            return p.innerHTML;
        }

        // YouTube IFrame Player API Setup
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // YouTube API Ready
        function onYouTubeIframeAPIReady() {
            console.log('🎬 YouTube IFrame API Ready');
            
            // Set up periodic button state updates
            setInterval(() => {
                if (player && typeof player.getPlayerState === 'function') {
                    updatePlayPauseButton();
                }
            }, 1000); // Update every second
        }

        // Player ready event
        function onPlayerReady(event) {
            console.log('🎬 Player ready');
            // Note taker is now always visible, no need to show/hide
            console.log('✅ Note taking area is ready');
            
            // Set initial play/pause button state
            updatePlayPauseButton();
        }
        
        // Update play/pause button state based on player state
        function updatePlayPauseButton() {
            if (!toolbarPlayPause || !player || typeof player.getPlayerState !== 'function') return;
            
            const playerState = player.getPlayerState();
            if (playerState === 1) { // Playing
                toolbarPlayPause.innerHTML = '⏸️ Pause';
                toolbarPlayPause.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition';
            } else { // Paused, ended, or buffering
                toolbarPlayPause.innerHTML = '▶️ Play';
                toolbarPlayPause.className = 'bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition';
            }
        }

        console.log('✅ Cloud version JavaScript loaded successfully');
        console.log(`🌐 Using ${USE_CLOUD ? 'Cloud API' : 'localStorage'} for data storage`);
    </script>
</body>
</html>
